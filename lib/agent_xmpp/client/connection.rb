##############################################################################################################
module AgentXmpp
  
  #####-------------------------------------------------------------------------------------------------------
  class Connection < EventMachine::Connection

    #---------------------------------------------------------------------------------------------------------
    include Parser
    #---------------------------------------------------------------------------------------------------------

    #---------------------------------------------------------------------------------------------------------
    attr_reader :client, :jid, :port, :password, :connection_status, :delegates, :keepalive, :message_pipe               
    #---------------------------------------------------------------------------------------------------------

    #.........................................................................................................
    def initialize(client, jid, password, message_pipe, port=5222)
      @client, @jid, @password, @message_pipe, @port = client, jid, password, message_pipe, port
      @connection_status = :offline;
      @message_pipe.connection = self
    end
    
    #---------------------------------------------------------------------------------------------------------
    # EventMachine::Connection callbacks
    #.........................................................................................................
    def connection_completed
      @keepalive = EventMachine::PeriodicTimer.new(60) do 
        send_data("\n")
      end
      message_pipe.connection_completed
    end

    #.........................................................................................................
    def receive_data(data)
      super(data)
    end

    #.........................................................................................................
    def unbind
      if @keepalive
        @keepalive.cancel
        @keepalive = nil
      end
      message_pipe.unbind
    end

    #---------------------------------------------------------------------------------------------------------
    # AgentXmpp::Parser callbacks
    #.........................................................................................................
    def receive(stanza)
      message_pipe.receive(stanza)
    end
  
  #### Connection
  end

#### AgentXmpp
end
