= Agent XMPP

Agent XMPP is a simple DSL for writing XMPP bots that respond to Ad-Hoc Commands.
Ad-Hoc Commands are described in XMPP extension XEP-0050 (see http://xmpp.org/extensions/xep-0050.html).

    # mybot.rb
    require 'rubygems'
    require 'agent_xmpp'

    execute 'hello' do
      'Hello World' 
    end

Specify the agent Jabber ID (JID), password and roster in agent_xmpp.yml.

    jid: mybot@nowhere.com
    password: pass
    roster:
        - you@home.com
        - someone@somewhere.com

Install the gem and run

    sudo gem install troystribling-agent_xmpp --source=http://gems.github.com
    ruby mybot.rb

Request and response payloads use the jabber:x:data protocol described in XMPP extension 
XEP-0004 (see http://xmpp.org/extensions/xep-0004.html).

When first started mybot.rb will automatically send buddy requests to all contacts specified
in the agent_xmpp.yml. Accept the buddy request and send commands.

mybot.rb will respond to the request,

    <iq id='5644' to='mybot@nowhere.com/mybot-host' type='set' xmlns='jabber:client'>
        <command node='hello' action='execute' xmlns='http://jabber.org/protocol/commands'/>
    </iq>
    
with

    <iq from='mybot@nowhere.com/mybot-host' to='you@home.com/your-host' id='5644' type='result' xmlns='jabber:client'>
        <command node='scalar' action='completed' xmlns='http://jabber.org/protocol/commands'>
            <x type='result' xmlns='jabber:x:data'>
                <field><value>Hello World</value></field>
            </x>
        </command>
    </iq>    

== Response Payloads

Agent XMPP supports mapping scalar, arrays and hashes to jabber:x:data payloads

    execute 'scalar' do
      'scalar' 
    end

    execute 'hash' do
      {:attr1 => 'val1', :attr2 => 'val2'}
    end

    execute 'scalar_array' do
      ['val1', 'val2','val3', 'val4'] 
    end

    execute 'hash_array' do
      {:attr1 => ['val11', 'val11'], :attr2 => 'val12'}
    end

    execute 'array_hash' do
      [{:attr1 => 'val11', :attr2 => 'val12'}, 
       {:attr1 => 'val21', :attr2 => 'val22'}, 
       {:attr1 => 'val31', :attr2 => 'val32'}]
    end

    execute 'array_hash_array' do
      [{:attr1 => ['val11', 'val11'], :attr2 => 'val12'}, 
       {:attr1 => ['val21', 'val21'], :attr2 => 'val22'}, 
       {:attr1 => ['val31', 'val31'], :attr2 => 'val32'}]
    end

== Application Startup Callbacks

Callback methods are available for applications and should be placed in boot.rb

    AgentXmpp::Boot.before_start do
    end

    AgentXmpp::Boot.after_connected do |pipe|
    end

    AgentXmpp::Boot.restarting_server do |pipe|
    end

== Logging

By default log messages are written to STDOUT. A log file can be specified with the -l option.

    ruby mybot.rb -l file.log

The logger can be accessed with,

    AgentXmpp.logger

The logger can be configured in the before_start callback.

    AgentXmpp::Boot.before_start do
      AgentXmpp.logger.level = Logger::WARN  
    end

== Copyright

Copyright (c) 2009 Troy Stribling. See LICENSE for details.
